<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VORTEKS ‚Äî Unicode Card Battler</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div class="wrap">
    <h1>VORTEKS</h1>

    <!-- Opponent Panel -->
    <div class="panel" id="oppPanel">
      <div class="opp-box">
        <div>
          <canvas id="oppFace" width="96" height="96" aria-label="Opponent face"></canvas>
          <div id="oppName">NAME</div>
        </div>
        <div>
          <div class="hud">
            <div class="pill">OPP ‚ù§<span id="oppHP"></span></div>
            <div class="pill sh">üõ°<span id="oppSH"></span></div>
            <div class="pill en">‚ö°<span id="oppEN"></span></div>
            <button id="rerollFace" class="btn">REROLL FACE</button>
          </div>
          <div class="status" id="oppStatus"></div>
        </div>
      </div>
    </div>

    <!-- Player Panel -->
    <div class="panel" id="youPanel">
      <div class="hud">
        <div class="pill">YOU ‚ù§<span id="youHP"></span></div>
        <div class="pill sh">üõ°<span id="youSH"></span></div>
        <div class="pill en">‚ö°<span id="youEN"></span></div>
        <div class="pill">STREAK <span id="streak"></span></div>
      </div>
      <div class="status" id="youStatus"></div>
      <div class="hand" id="hand"></div>
      <div class="controls">
        <button id="endTurn" class="btn">END TURN</button>
        <button id="restart" class="btn">RESTART</button>
        <button id="selfTest" class="btn" title="Run built-in tests">SELF‚ÄëTESTS</button>
      </div>
    </div>

    <!-- Log Panel -->
    <div class="panel">
      <div class="log" id="log" aria-live="polite"></div>
    </div>
  </div>

  <!-- Start Screen Modal -->
  <div class="modal" id="startModal">
    <div class="box" style="text-align:center; width:min(96vw, 480px)">
      <div style="font-size:24px; color:var(--accent); margin:8px 0 14px">VORTEKS</div>
      <div style="display:flex; gap:8px; justify-content:center">
        <button id="startBtn" class="btn">BUILD DECK</button>
        <button id="quickBtn" class="btn">QUICK START</button>
      </div>
    </div>
  </div>

  <!-- Deck Builder Modal -->
  <div class="modal" id="deckModal" hidden>
    <div class="box">
      <div><strong>Build Your Deck</strong> ‚Äî pick <span id="deckNeed">20</span> cards (max 4 of any one).</div>
      <div class="qgrid" id="deckGrid"></div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:space-between">
        <div>Selected: <span id="deckCount">0</span>/20</div>
        <div>
          <button id="deckQuick" class="btn" title="Fill a random valid deck">QUICK PLAY</button>
          <button id="deckClear" class="btn">CLEAR</button>
          <button id="deckConfirm" class="btn" disabled>CONFIRM</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quirk Picker Modal -->
  <div class="modal" id="quirkModal" hidden>
    <div class="box">
      <div><strong>Pick a Quirk</strong> ‚Äî one‚Äëline identity for this run.</div>
      <div class="qgrid">
        <div class="qcard" data-quirk="minty">MINTY<br/><small>Start with +1 max ‚ö° (and +1 now).</small></div>
        <div class="qcard" data-quirk="spicy">SPICY<br/><small>Your Burns deal +1.</small></div>
        <div class="qcard" data-quirk="piercer">PIERCER<br/><small>Your first attack each turn pierces 1.</small></div>
      </div>
    </div>
  </div>

  <!-- Import modules and initialize game -->
  <script type="module">
    import { $ } from './src/utils.js';
    import { initFaceGenerator, drawOppFace, setOpponentName } from './src/face-generator.js';
    import { Game, setLogFunction } from './src/game.js';
    import { createRenderFunction, bump, bumpHP, bumpShield } from './src/ui.js';
    import { openDeckBuilder, buildRandomDeck } from './src/deck-builder.js';
    import { makePersonaDeck } from './src/ai.js';
    import { runSelfTests } from './src/tests.js';

    // Initialize game components
    (() => {
      // DOM helpers
      const logBox = $('#log');
      const log = (t) => { 
        const p = document.createElement('div'); 
        p.textContent = '> ' + t; 
        logBox.prepend(p);
      };

      // Set up logging
      setLogFunction(log);

      // Initialize face generator
      initFaceGenerator();

      // Create render function and make it globally available
      const render = createRenderFunction(Game);
      window.render = render;

      // Make functions globally available for game logic
      window.openDeckBuilder = openDeckBuilder;
      window.buildRandomDeck = buildRandomDeck;
      window.bump = bump;
      window.bumpHP = bumpHP;
      window.bumpShield = bumpShield;

      // Start Screen functionality
      function showStart() {
        const modal = document.getElementById('startModal');
        modal.hidden = false;
        document.getElementById('startBtn').onclick = () => { 
          modal.hidden = true; 
          Game.init(); 
        };
        document.getElementById('quickBtn').onclick = () => { 
          modal.hidden = true; 
          Game.initQuick(); 
        };
      }

      // Controls
      $('#endTurn').onclick = () => Game.endTurn();
      $('#restart').onclick = () => { 
        log('‚Äî'); 
        showStart(); 
      };
      $('#rerollFace').onclick = () => {
        const faceInfo = drawOppFace();
        Game.persona = faceInfo.persona;
        setOpponentName(Game.persona);
        // Rebuild opponent deck to match new face/persona and redraw their hand to same size
        const keepN = Game.opp.hand ? Game.opp.hand.length : 5;
        Game.opp.deck = makePersonaDeck(Game.persona);
        Game.opp.hand = [];
        Game.opp.discard = [];
        Game.opp.draw(keepN || 5);
        log('Opponent shifts to ' + Game.persona + ' persona. Deck re-tuned.');
        render();
      };
      $('#selfTest')?.addEventListener('click', () => runSelfTests(Game, log, showStart));

      // Boot
      showStart();
    })();
  </script>
</body>
</html>